name: Update Application Repository Secrets

# This workflow updates GitHub secrets in your application repository
# with the EC2 instance details from Terraform

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., username/k8s-app-repo)'
        required: true
        type: string
      deploy_path:
        description: 'Deploy path on EC2 (e.g., /home/ubuntu/app)'
        required: false
        default: '/home/ubuntu/app'
        type: string

jobs:
  update-secrets:
    name: Update GitHub Secrets
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.0
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ca-west-1

      - name: Terraform Init
        run: terraform init

      - name: Get EC2 Public IP
        id: terraform
        run: |
          # Get EC2 public IP from Terraform remote state
          PUBLIC_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")

          if [ -z "$PUBLIC_IP" ]; then
            echo "âŒ Error: Could not get EC2 public IP from terraform"
            echo ""
            echo "This likely means:"
            echo "  1. Terraform state is local (not in S3)"
            echo "  2. No instance has been created yet"
            echo ""
            echo "Make sure you've set up remote state and run terraform apply"
            exit 1
          fi

          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "âœ… EC2 Public IP: $PUBLIC_IP"

      - name: Validate PEM Key Secret
        run: |
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: EC2_SSH_PRIVATE_KEY secret not found in this repository"
            echo ""
            echo "After running 'terraform apply', upload the PEM key:"
            echo "  ./scripts/upload-pem-to-github.sh"
            echo ""
            echo "Or manually:"
            echo "  1. Copy: cat k8s-vms-key.pem | pbcopy"
            echo "  2. Go to: Settings â†’ Secrets â†’ Actions"
            echo "  3. Add secret: EC2_SSH_PRIVATE_KEY"
            exit 1
          fi
          echo "âœ… EC2_SSH_PRIVATE_KEY secret found"

      - name: Update Target Repository Secrets
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ inputs.target_repo }}
          EC2_HOST: ${{ steps.terraform.outputs.public_ip }}
          EC2_USER: 'ubuntu'
          DEPLOY_PATH: ${{ inputs.deploy_path }}
          SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "ðŸ”„ Updating secrets in repository: $TARGET_REPO"
          echo ""

          # Update EC2_HOST
          echo "  Updating EC2_HOST..."
          echo "$EC2_HOST" | gh secret set EC2_HOST --repo "$TARGET_REPO"
          echo "  âœ… EC2_HOST = $EC2_HOST"

          # Update EC2_SSH_PRIVATE_KEY
          echo "  Updating EC2_SSH_PRIVATE_KEY..."
          echo "$SSH_KEY" | gh secret set EC2_SSH_PRIVATE_KEY --repo "$TARGET_REPO"
          echo "  âœ… EC2_SSH_PRIVATE_KEY = [REDACTED]"

          # Update EC2_USER
          echo "  Updating EC2_USER..."
          echo "$EC2_USER" | gh secret set EC2_USER --repo "$TARGET_REPO"
          echo "  âœ… EC2_USER = $EC2_USER"

          # Update DEPLOY_PATH
          echo "  Updating DEPLOY_PATH..."
          echo "$DEPLOY_PATH" | gh secret set DEPLOY_PATH --repo "$TARGET_REPO"
          echo "  âœ… DEPLOY_PATH = $DEPLOY_PATH"

          echo ""
          echo "âœ… All secrets updated successfully in $TARGET_REPO!"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Secrets Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Secrets in \`${{ inputs.target_repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`EC2_HOST\` | \`${{ steps.terraform.outputs.public_ip }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`EC2_USER\` | \`ubuntu\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`EC2_SSH_PRIVATE_KEY\` | âœ… Updated (not shown for security) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`DEPLOY_PATH\` | \`${{ inputs.deploy_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [\`${{ inputs.target_repo }}\`](https://github.com/${{ inputs.target_repo }})" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify secrets: Settings â†’ Secrets â†’ Actions" >> $GITHUB_STEP_SUMMARY
          echo "3. Trigger your deployment workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PEM key transferred securely via GitHub Secrets API" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No private keys exposed in logs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secrets encrypted at rest in target repository" >> $GITHUB_STEP_SUMMARY
