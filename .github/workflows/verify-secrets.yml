name: Verify AWS Secrets (OIDC)

# This workflow demonstrates OIDC authentication with AWS
# It can be used to verify that secrets were correctly stored after terraform apply
# No AWS credentials are stored in GitHub - authentication happens via OIDC

on:
  workflow_dispatch:
    inputs:
      show_ip:
        description: 'Show EC2 public IP in logs'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  AWS_REGION: ca-west-1

jobs:
  verify-secrets:
    name: Verify Secrets via OIDC
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify EC2 Public IP Secret
        run: |
          echo "ðŸ” Reading EC2 public IP from Secrets Manager..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-public-ip" \
            --query 'SecretString' \
            --output text)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ EC2 public IP secret is empty or not found"
            exit 1
          fi

          if [ "${{ inputs.show_ip }}" == "true" ]; then
            echo "âœ… EC2 Public IP: $SECRET_VALUE"
          else
            echo "âœ… EC2 Public IP secret exists (hidden for security)"
          fi

      - name: Verify SSH Key Secret
        run: |
          echo "ðŸ” Verifying SSH key secret exists..."

          # Just check it exists and is valid PEM format, don't print it
          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-ssh-private-key" \
            --query 'SecretString' \
            --output text)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ SSH key secret is empty or not found"
            exit 1
          fi

          # Verify it's a valid PEM format
          if echo "$SECRET_VALUE" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âœ… SSH private key secret exists and is valid PEM format"
          else
            echo "âŒ SSH key secret exists but doesn't appear to be valid PEM format"
            exit 1
          fi

      - name: Verify Connection Info Secret
        run: |
          echo "ðŸ” Verifying connection info secret..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-connection-info" \
            --query 'SecretString' \
            --output text)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ Connection info secret is empty or not found"
            exit 1
          fi

          # Verify it's valid JSON with expected fields
          if echo "$SECRET_VALUE" | jq -e '.host and .user and .private_key' > /dev/null 2>&1; then
            echo "âœ… Connection info secret exists with all required fields"

            if [ "${{ inputs.show_ip }}" == "true" ]; then
              HOST=$(echo "$SECRET_VALUE" | jq -r '.host')
              USER=$(echo "$SECRET_VALUE" | jq -r '.user')
              echo "   Host: $HOST"
              echo "   User: $USER"
            fi
          else
            echo "âŒ Connection info secret is missing required fields"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## âœ… All Secrets Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-public-ip\` | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-ssh-private-key\` | âœ… Valid PEM |" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-connection-info\` | âœ… Valid JSON |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OIDC Authentication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No AWS credentials stored in GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Authenticated via OIDC role assumption" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Role: \`${{ vars.AWS_ROLE_ARN }}\`" >> $GITHUB_STEP_SUMMARY
