name: Update and Verify AWS Secrets

# This workflow updates and verifies secrets in AWS Secrets Manager
# Run this manually after `terraform apply` to sync EC2 info to AWS Secrets Manager
# NO SENSITIVE DATA IS PRINTED - secrets are passed securely and never logged
# Authentication happens via OIDC - no AWS credentials stored in GitHub

on:
  workflow_dispatch:
    inputs:
      public_ip:
        description: 'EC2 Public IP (from terraform output instance_public_ip)'
        required: true
        type: string
      ssh_private_key:
        description: 'SSH Private Key (from k8s-vms-key.pem - base64 encoded)'
        required: true
        type: string

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  update-and-verify-secrets:
    name: Update and Verify Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ec2-k8s
          aws-region: ca-west-1

      - name: Update EC2 Public IP Secret
        run: |
          echo "ðŸ“ Updating EC2 public IP secret..."

          # Create or update the secret
          aws secretsmanager create-secret \
            --name "k8s-vms/ec2-public-ip" \
            --description "Public IP address of EC2 K8s VMs host" \
            --secret-string "${{ inputs.public_ip }}" 2>/dev/null || \
          aws secretsmanager update-secret \
            --secret-id "k8s-vms/ec2-public-ip" \
            --secret-string "${{ inputs.public_ip }}"

          echo "âœ… EC2 Public IP secret updated"

      - name: Update SSH Key Secret
        run: |
          echo "ðŸ“ Updating SSH key secret..."

          # Decode base64 SSH key
          SSH_KEY=$(echo "${{ inputs.ssh_private_key }}" | base64 -d)

          # Create or update the secret
          aws secretsmanager create-secret \
            --name "k8s-vms/ec2-ssh-private-key" \
            --description "SSH private key for EC2 K8s VMs host" \
            --secret-string "$SSH_KEY" 2>/dev/null || \
          aws secretsmanager update-secret \
            --secret-id "k8s-vms/ec2-ssh-private-key" \
            --secret-string "$SSH_KEY"

          echo "âœ… SSH private key secret updated"

      - name: Verify EC2 Public IP Secret
        run: |
          echo "ðŸ” Verifying EC2 public IP secret..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-public-ip" \
            --query 'SecretString' \
            --output text 2>/dev/null)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ EC2 public IP secret not found or empty"
            exit 1
          fi

          # Verify it looks like an IP address (basic check)
          if echo "$SECRET_VALUE" | grep -qE '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$'; then
            echo "âœ… EC2 Public IP secret exists and is valid format"
          else
            echo "âŒ EC2 public IP secret exists but doesn't look like an IP address"
            exit 1
          fi

      - name: Verify SSH Key Secret
        run: |
          echo "ðŸ” Verifying SSH key secret..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-ssh-private-key" \
            --query 'SecretString' \
            --output text 2>/dev/null)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ SSH key secret not found or empty"
            exit 1
          fi

          # Verify it's a valid PEM format (without printing the key)
          if echo "$SECRET_VALUE" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âœ… SSH private key secret exists and is valid PEM format"
          else
            echo "âŒ SSH key secret doesn't appear to be valid PEM format"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## âœ… Secrets Updated and Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All secrets have been updated in AWS Secrets Manager and verified." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-public-ip\` | âœ… Updated & Verified |" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-ssh-private-key\` | âœ… Updated & Verified |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No sensitive data printed in logs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No AWS credentials stored in GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Authenticated via OIDC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Run This Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After running \`terraform apply\` locally:" >> $GITHUB_STEP_SUMMARY
          echo "1. Get the public IP: \`terraform output instance_public_ip\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Encode the SSH key: \`cat k8s-vms-key.pem | base64\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run this workflow manually with those values as inputs" >> $GITHUB_STEP_SUMMARY
