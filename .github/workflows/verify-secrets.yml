name: Verify AWS Secrets (OIDC)

# This workflow verifies that secrets were correctly stored in AWS Secrets Manager
# NO SENSITIVE DATA IS PRINTED - only verification that secrets exist and are valid
# Authentication happens via OIDC - no AWS credentials stored in GitHub

on:
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  verify-secrets:
    name: Verify Secrets via OIDC
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # TODO: After running 'terraform apply', update this with the actual ARN from:
          # terraform output github_actions_role_arn
          role-to-assume: arn:aws:iam::449873021552:role/github-actions-ec2-k8s
          aws-region: ca-west-1

      - name: Verify EC2 Public IP Secret
        run: |
          echo "ðŸ” Verifying EC2 public IP secret exists..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-public-ip" \
            --query 'SecretString' \
            --output text 2>/dev/null)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ EC2 public IP secret not found or empty"
            exit 1
          fi

          # Verify it looks like an IP address (basic check)
          if echo "$SECRET_VALUE" | grep -qE '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$'; then
            echo "âœ… EC2 Public IP secret exists and is valid format"
          else
            echo "âŒ EC2 public IP secret exists but doesn't look like an IP address"
            exit 1
          fi

      - name: Verify SSH Key Secret
        run: |
          echo "ðŸ” Verifying SSH key secret exists..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-ssh-private-key" \
            --query 'SecretString' \
            --output text 2>/dev/null)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ SSH key secret not found or empty"
            exit 1
          fi

          # Verify it's a valid PEM format (without printing the key)
          if echo "$SECRET_VALUE" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âœ… SSH private key secret exists and is valid PEM format"
          else
            echo "âŒ SSH key secret doesn't appear to be valid PEM format"
            exit 1
          fi

      - name: Verify Connection Info Secret
        run: |
          echo "ðŸ” Verifying connection info secret..."

          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-connection-info" \
            --query 'SecretString' \
            --output text 2>/dev/null)

          if [ -z "$SECRET_VALUE" ]; then
            echo "âŒ Connection info secret not found or empty"
            exit 1
          fi

          # Verify it's valid JSON with expected fields (without printing values)
          if echo "$SECRET_VALUE" | jq -e '.host and .user and .private_key and .port' > /dev/null 2>&1; then
            echo "âœ… Connection info secret exists with all required fields (host, user, private_key, port)"
          else
            echo "âŒ Connection info secret is missing required fields"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## âœ… All Secrets Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All secrets exist in AWS Secrets Manager and are valid." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-public-ip\` | âœ… Valid IP format |" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-ssh-private-key\` | âœ… Valid PEM format |" >> $GITHUB_STEP_SUMMARY
          echo "| \`k8s-vms/ec2-connection-info\` | âœ… Valid JSON with all fields |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No sensitive data printed in logs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No AWS credentials stored in GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Authenticated via OIDC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** To see instance IP and connection info, run \`terraform output\` locally."
